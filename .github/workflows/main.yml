name: Release Notification to Slack

on:
  release:
    types: [created, published, released, prereleased]
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã®å–å¾—ã«å¿…è¦ï¼‰

      # ãƒªãƒªãƒ¼ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã€ã¾ãŸã¯æœ€æ–°ã®ãƒªãƒªãƒ¼ã‚¹ã‚’å–å¾—
      - name: Get release information
        id: get_release
        uses: actions/github-script@v7
        with:
          script: |
            let latestRelease;
            
            // ãƒªãƒªãƒ¼ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚ˆã£ã¦ãƒˆãƒªã‚¬ãƒ¼ã•ã‚ŒãŸå ´åˆ
            if (context.eventName === 'release') {
              console.log('Triggered by release event');
              latestRelease = context.payload.release;
            } else {
              // æ‰‹å‹•å®Ÿè¡Œã‚„ãã®ä»–ã®ãƒˆãƒªã‚¬ãƒ¼ã®å ´åˆã¯æœ€æ–°ã®ãƒªãƒªãƒ¼ã‚¹ã‚’å–å¾—
              console.log('Fetching latest release');
              const { data: releases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 1
              });
              
              if (releases.length === 0) {
                core.setFailed('No releases found');
                return;
              }
              
              latestRelease = releases[0];
            }
            
            console.log(`Release: ${latestRelease.name || latestRelease.tag_name}, Draft: ${latestRelease.draft}, Created: ${latestRelease.created_at}`);
            
            core.setOutput('release_name', latestRelease.name || latestRelease.tag_name);
            core.setOutput('is_draft', latestRelease.draft ? 'true' : 'false');
            core.setOutput('is_prerelease', latestRelease.prerelease ? 'true' : 'false');
            
            // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’JSONå®‰å…¨ãªå½¢å¼ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            let releaseBody = latestRelease.body || 'No release notes provided';
            // æ”¹è¡Œã‚’\nã«å¤‰æ›ã—ã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            releaseBody = releaseBody.replace(/\\/g, '\\\\')
                                     .replace(/"/g, '\\"')
                                     .replace(/\n/g, '\\n')
                                     .replace(/\r/g, '\\r')
                                     .replace(/\t/g, '\\t');
            
            core.setOutput('release_body', releaseBody);
            core.setOutput('release_url', latestRelease.html_url);
            core.setOutput('release_tag', latestRelease.tag_name);

      # ãƒãƒ¼ã‚¸ã‚’å®Ÿè¡Œã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
      - name: Get merge author
        id: get_author
        run: |
          echo "author=${{ github.actor }}" >> $GITHUB_OUTPUT

      # Slackãƒãƒ£ãƒ³ãƒãƒ«åã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: #releasesï¼‰
      - name: Set Slack channel
        id: slack_channel
        run: |
          echo "channel=${{ vars.SLACK_RELEASE_CHANNEL || '#private' }}" >> $GITHUB_OUTPUT

      # Slackã«ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆWeb APIã‚’ä½¿ç”¨ï¼‰
      - name: Send main notification to Slack
        id: slack_main
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ steps.slack_channel.outputs.channel }}
          payload: |
            {
              "text": "ğŸš€ æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸ",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš€ ãƒªãƒªãƒ¼ã‚¹é€šçŸ¥"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒªãƒã‚¸ãƒˆãƒª:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒãƒ¼ã‚¸ãƒ§ãƒ³:*\n${{ steps.get_release.outputs.release_name }}${{ steps.get_release.outputs.is_draft == 'true' && ' (Draft)' || '' }}${{ steps.get_release.outputs.is_prerelease == 'true' && ' (Pre-release)' || '' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*å®Ÿè¡Œè€…:*\n${{ steps.get_author.outputs.author }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒªãƒ³ã‚¯:*\n<${{ steps.get_release.outputs.release_url }}|GitHubã§ç¢ºèª>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.TEST_SLACK_BOT_TOKEN }}

      # ã‚¹ãƒ¬ãƒƒãƒ‰ã«ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’æŠ•ç¨¿
      - name: Send release notes as thread reply
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ steps.slack_channel.outputs.channel }}
          payload: |
            {
              "thread_ts": "${{ steps.slack_main.outputs.ts }}",
              "text": "ğŸ“ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆè©³ç´°",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ“ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ (${{ steps.get_release.outputs.release_tag }})"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.get_release.outputs.release_body }}"
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.TEST_SLACK_BOT_TOKEN }}

      # ã‚¨ãƒ©ãƒ¼æ™‚ã®é€šçŸ¥ï¼ˆWebhookã‚’ä½¿ç”¨ï¼‰
      - name: Notify failure to Slack
        if: failure()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "âŒ ãƒªãƒªãƒ¼ã‚¹é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âŒ *ãƒªãƒªãƒ¼ã‚¹é€šçŸ¥ã‚¨ãƒ©ãƒ¼*\n*ãƒªãƒã‚¸ãƒˆãƒª:* ${{ github.repository }}\n*å®Ÿè¡Œè€…:* ${{ github.actor }}\n*ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|è©³ç´°ã‚’ç¢ºèª>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.TEST_SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
